!function(f){"use strict";var h=f.extend({fieldClass:".comment-form-gv-review,.gv-star-rate-holder,.gv-vote-rating",respondId:"#respond",respondTempId:"#gv-ratings-reviews-temp-respond",commentParentId:"#comment_parent",commentId:"#comment",commentLabel:'label[for="comment"]:first',commentSubmit:'input[name="submit"]:first',replyTextId:"#reply-title",cancelId:"#cancel-comment-reply-link"},GV_RATINGS_REVIEWS);h.init=function(){h._holder=".gv-star-rate-holder, .gv-vote-rate-holder",f(h._holder).length<=0||(h._star=".gv-star-rate",h._vote=".gv-vote-up, .gv-vote-down",h._input=".gv-star-rate-field",h._text=".gv-vote-rating-text",h._mutated=".gv-rate-mutated",h.$field=f(h._input),h.reply=f(".comment-reply-login, .comment-reply-link"),h.reply.removeAttr("onclick"),h.reply.on("click",h.moveForm),h.starHolder=f(h._holder),h.star=h.starHolder.find(h._star),h.star.on("click touchend",h.starRateReview).on("mouseover",h.mouseOverStar).on("mouseout",h.mouseOutStar),0!==parseInt(h.$field.val(),10)&&h.star.eq(parseInt(h.$field.val(),10)-1).trigger("click"),h.voteHolder=f(".gv-vote-rate-holder"),f.merge(h.starHolder,h.voteHolder).each(function(){var e=f(this),t=e.data("view-id"),a=e.data("entry-id");h.limit_one_review_per_person&&"true"===localStorage.getItem(t+`-${a}-rated`)&&e.parent().html(h.already_reviewed_text)}),h.vote=f("a.gv-vote-up, a.gv-vote-down",h.voteHolder),h.vote.on("click touchend",h.voteRateReview),h.originalReplyText=h.getText(f(h.replyTextId)),h.originalCancelReplyText=h.getText(f(h.cancelId)),h.originalCommentLabelText=h.getText(f(h.commentLabel)),h.originalCommentSubmitText=f(h.commentSubmit).val(),f(h.commentSubmit).on("click",h.validateRatingRequired),h.$field.on("change",h.setRatingRequiredState),h.editReview())},h.setStars=function(){f(".gv-star-rate-field").length&&f(".gv-star-rate-field").each(function(e,t){var a=parseInt(f(t).val(),10);1<=a&&a<=5&&f(t).parent().find(".gv-star-rate:eq("+(a-1)+")").trigger("click")})},h.reviewTimer=function(){f(".review-edit-duration").each(function(){var e=f(this),t=new Date(e.data("edit-time-left"));0<t&&h.editReviewTimer(e,t)})},h.editReviewTimer=function(n,i){!function e(){var t=Math.floor(i/3600),a=Math.floor(i%3600/60),r=Math.floor(i%3600%60);n.text((0<t?t+":":"")+(0<t||0<a?(a<10&&0<t?"0":"")+a+":":"")+(r<10?"0":"")+r),0<=--i?setTimeout(e,1e3):n.fadeOut().remove()}()},h.editReview=function(){h.setStars(),h.reviewTimer(),f("a.gv-review-edit-button").on("click",function(e){e.preventDefault();e=f(this).data("commentid");f("#gv-review-"+e).toggle()}),f("button.gv-review-edit-cancel").on("click",function(e){e.preventDefault();f(this).data("commentid");f(this).parents(".gv-review-edit-area").hide().prev().show()})},h.moveForm=function(e){var e=f(e.target).parent().parent(),t=f(h.respondId),a=f(h.respondTempId),r=f(h.commentParentId),n=f(h.fieldClass);return a.length||((a=f("<div></div>")).attr("id",h.respondTempId.substr(1)),a.hide(),t.parent().append(a)),e.append(t),r.val(e.data("review_id")),n.hide(),h.replaceReplyText(h.comment_to_review_text,h.cancel_comment_to_review_text,h.comment_label_when_reply,h.comment_submit_when_reply),f(h.cancelId).show().on("click",h.cancelReply),f(h.commentId).focus(),!1},h.getText=function(e){return(e=f(e)).clone().children().remove().end().text()},h.replaceReplyText=function(e,t,a,r){var n=f(h.replyTextId),i=f(h.cancelId),o=f(h.commentLabel),d=f(h.commentSubmit);n.contents().each(function(){this.nodeType===this.TEXT_NODE&&(this.nodeValue=this.nodeValue.trim(),this.nodeValue.length)&&(this.nodeValue=e)}),i.text(t),o.text(a),d.val(r)},h.cancelReply=function(e){var t=f(h.respondTempId),a=f(h.respondId),r=f(h.commentParentId),e=f(e.target),n=f(h.fieldClass);if(t.length&&a.length)return r.val(0),t.parent().append(a),t.remove(),h.replaceReplyText(h.originalReplyText,h.originalCancelReplyText,h.originalCommentLabelText,h.originalCommentSubmitText),e.hide(),e.off("click",h.cancelReply),n.show(),!1},h.mouseOverStar=function(e){var t=f(this),a=t.parents(h._holder).find(h._star),r=a.index(t);a.removeClass("gv-rate-mutated").each(function(e,t){t=f(t);r+1<=e||t.addClass("gv-rate-mutated")})},h.mouseOutStar=function(e){var t,a=parseInt(f(this).parent().attr("data-star-rating"),10);h.multiple_entries&&0<=a?(t=0,f(this).parent().find(".gv-star-rate").each(function(){f(this).removeClass("gv-rate-mutated"),t<a&&f(this).addClass("gv-rate-mutated"),++t})):f(this).parents(h._holder).find(h._star).removeClass("gv-rate-mutated").filter('[data-selected="1"]').addClass("gv-rate-mutated")},h.starRateReview=function(e){e.stopPropagation();var t,a,r,n,i,o=f(this),d=o.parents(h._holder),l=d.find(h._star),d=d.siblings(h._input),s=l.index(o);d.val(s+1).trigger("change"),l.removeClass("gv-rate-mutated").attr("data-selected",0).each(function(e,t){t=f(t);s+1<=e||t.addClass("gv-rate-mutated").attr("data-selected",1)}),h.multiple_entries&&(t=f(this).parent(),a=t.attr("data-star-rating"),o=t.find(".gv-rate-mutated").length,r=!1,n=t.attr("data-view-id"),i=t.attr("data-entry-id"),t.attr("data-star-rating",o),f.ajax({type:"post",dataType:"json",url:h.ajaxurl,data:{action:h.action,nonce:h.nonce,comment_id:t.attr("data-comment-id"),view_id:n,entry_id:i,update_rating:t.attr("data-rated"),rating:o,type:"star"},beforeSend:function(){t.animate({opacity:.5},200).attr("aria-busy","true")},success:function(e){e.success?(localStorage.setItem(n+`-${i}-rated`,"true"),h.limit_one_review_per_person&&f(`[data-view-id="${n}"][data-entry-id="${i}"]`).parent().html(h.already_reviewed_text),t.attr("data-rated",!0),t.attr("data-comment-id",e.data.comment_id)):r=!0},error:function(){r=!0},complete:function(){r&&t.attr("data-star-rating",a),t.animate({opacity:1},200).attr("aria-busy","false"),f(e.target).trigger("mouseout")}}))},h.voteRateReview=function(e){var t,a,r,n,i,o,d,l=f(this),s=l.parents(h._holder),c=s.find(h._vote),m=s.siblings(h._input),v=s.find(h._text),u=c.filter(h._mutated),u=l.is(u)?0:l.hasClass("gv-vote-up")?1:-1,p=0==u?h.vote_zero:1==u?h.vote_up:h.vote_down,g=0==u?h.vote_zero:_.template(h.vote_text_format)({number:u});return h.ajaxurl&&(t=f(this).parent(),a=t.attr("data-vote"),r=v.text(),n=v.attr("title"),i=!1,o=t.attr("data-view-id"),d=t.attr("data-entry-id"),f.ajax({type:"post",dataType:"json",url:h.ajaxurl,data:{action:h.action,nonce:h.nonce,view_id:o,comment_id:t.attr("data-comment-id"),entry_id:d,update_rating:t.attr("data-rated"),type:"vote",rating:String(u)},beforeSend:function(){t.animate({opacity:.5},200).attr("aria-busy","true")},success:function(e){e.success?(localStorage.setItem(o+`-${d}-rated`,"true"),h.limit_one_review_per_person&&f(`[data-view-id="${o}"][data-entry-id="${d}"]`).parent().html(h.already_reviewed_text),t.attr("data-rated",!0),t.attr("data-comment-id",e.data.comment_id)):i=!0},error:function(){i=!0},complete:function(){i&&(1==a?s.find("a.gv-vote-up").addClass("gv-rate-mutated"):-1==a&&s.find("a.gv-vote-down").addClass("gv-rate-mutated"),v.text(r).attr("title",n)),t.animate({opacity:1},200).attr("aria-busy","false")}})),c.removeClass("gv-rate-mutated"),0!=u&&l.addClass("gv-rate-mutated"),v.text(p).attr("title",g),m.val(u).trigger("change"),!1},h.validateRatingRequired=function(e){1===parseInt(h.$field.data("required"))&&""===h.$field.val()&&(e.preventDefault(),h.setRatingRequiredState())},h.setRatingRequiredState=function(){h.$field.closest(h.fieldClass).toggleClass("is-required",""===h.$field.val())},f(window).on("gravityview-datatables/event/draw",function(){f(h.init)}),f(h.init)}(jQuery,_);